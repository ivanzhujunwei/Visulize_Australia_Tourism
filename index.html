<html>
<head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js" charset="utf-8">
    </script>
    <!-- Plotly.js -->
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="js/jquery.min.js"></script>
    <script src="js/raphael.min.js"></script>
    <script src="js/kartograph.js"></script>
    <script src="bootstrap/js/bootstrap.min.js"></script>
    <link rel="stylesheet" href="bootstrap/css/bootstrap.min.css" type="text/css"/>
</head>
<body>
<div class="col-lg-12">
    <div class="col-lg-4"></div>
    <div id="map" class="col-lg-8"></div>
</div>
<div id="bar" style="width:550px;height: 500px;"></div>
<div style="left:20px" class="col-lg-12">
        <label>Expenditure on different visiting purpose:</label><br>
        <div class="btn-group" role="group">
            <button type="button" class="purpose btn btn-sm btn-default btn-primary" data-val="Allpurpose">All purposes
            </button>
            <button type="button" class="purpose btn btn-sm btn-default" data-val="Holiday">Holiday</button>
            <button type="button" class="purpose btn btn-sm btn-default" data-val="Business">Business</button>
            <button type="button" class="purpose btn btn-sm btn-default" data-val="Education">Education</button>
            <button type="button" class="purpose btn btn-sm btn-default" data-val="Employment">Employment</button>
            <button type="button" class="purpose btn btn-sm btn-default" data-val="Visiting friends and relatives">
                Visiting
                friends and relatives
            </button>
            <button type="button" class="purpose btn btn-sm btn-default" data-val="Otherreason">Other reasons</button>
        </div><br>
        <label style="margin-top:10px;">Measure:</label><br>
        <div class="btn-group" role="group">
            <button type="button" class="measure btn btn-sm btn-default btn-primary" data-val="TotalSpent">Total of all
                visitors spent
            </button>
            <button type="button" class="measure btn btn-sm btn-default" data-val="Average">Average of each visitor
                spent
            </button>
        </div>
    <br/>
    <div style="left:20px;margin-top: 10px;">
        The bar chart is sorted based on total spent or average spent, from highest expenditure to lowest expenditure country.<br>
        The map provides an overview about countries that visitors came from, the radius of circle indicates how much expenditure (total or average) visitors spent.<br>
        Once the buttons of purposes or measure are clicked, both bar chart and map will be udpate automatically.
    </div>
</div>
<hr style="background-color: #fff;border-top: 2px dashed #8c8b8b;margin-top: 230px;">
<div id="bubble"></div>
<div id="text" class="col-lg-12" style="margin-left: 40px;">
    <br>
    This visualization is combined with bubble chart and line chart, explaining the hidden relationship among:<br> 
    visiting purpose, average spent of each visitor, number of visitors visiting Australia and time.
    <br/>(1) Different legend can be clicked to hide or show corresponding visiting purpose data.
    <br/>(2) Hover mouse on the chart, detailed information will be displayed.
    <br/>(3) The radius of each circle indicates the number of visitors visited Australia in that year. If the circle is
    larger, then the number is higher.
</div>
<script>
    var map = kartograph.map('#map', 800, 500);
    var key, keyOfMeasure, scale, symbols, radius, proportion, barX, barY, keysSorted, colors, categories, wellData,
        yScale, xScale,
        layout_bar;

    //Width and height
    var w = 800;
    var h = 500;
    barX = [];
    barY = [];
    colors = {
        "Allpurpose": "#68d29c",
        "Holiday": "#38a6d2",
        "Business": "#ad61d2",
        "Education": "#ff0014",
        "Employment": "#5240d2",
        "Visiting friends and relatives": "#ff7a1c",
        "Otherreason": "#f4a4ff"
    };
    categories = ["Holiday",
        "Business",
        "Education",
        "Employment",
        "Visiting friends and relatives",
        "Otherreason"];

    var wellData = {};
    wellData.AllCountries = {
        "country": "AllCountries"
    };

    //Create SVG elements
    var svg = d3.select("#bar")
        .append("svg")
        .attr("width", w)
        .attr("height", h);

    d3.csv("06-16ExpenditureCategories.csv", function (error, data) {
        // initialise countries longitude and latitude
        var tourismData = data;
        d3.csv("countryGeo.csv", function (geoData) {
            var allGeoData = geoData;
            tourismData.forEach(function (d, i) {
                var countryName = d.Country;
                var continent = d.Continent;
                var year = d.Year;
                allGeoData.forEach(function (d, i) {
                    if (countryName == d.name && !wellData[countryName]) {
                        wellData[countryName] = {
                            "country": countryName,
                            "continent": continent,
                            "lon": d.longitude,
                            "lai": d.latitude
                        };
                        return false;
                    }
                });
                var category = d.Category;

                ///////Data Structure
                // Country
                //      - Total, lai, lon 
                //      - Year
                //           - Total
                //                 - Expenditure
                //                 - Visitors
                //                 - Average nights stay
                //           - Holiday
                //                 - Expenditure
                //                 - Visitors
                //                 - Average nights stay
                //           - Edudation
                //                 - Expenditure
                //                 - Visitors
                //                 - Average nights stay
                //           - ...

                var expenditure = parseInt(d.Expenditure);
                var visitors = parseInt(d.Visitors);
                var avgNights = parseFloat(d.AverageStayNights);

                ///////////////////////////////
                // category expenditure
                ///////////////////////////////
                // if the year's data is empty, then initalize it
                if (!wellData[countryName][year]) {
                    wellData[countryName][year] = {};
                    wellData[countryName][year]["Allpurpose"] = {
                        "expenditure": 0,
                        "visitors": 0,
                        "avgNights": 0
                    };
                }
                if (!wellData[countryName][year][category]) {
                    wellData[countryName][year][category] = {};
                }
                // set expenditure to each category
                wellData[countryName][year][category] = {
                    "expenditure": expenditure,
                    "visitors": visitors,
                    "avgNights": avgNights
                }
                if (!category.includes("packers")) {
                    // calculate totalSpent for each year
                    // var totalSpent = wellData[countryName][year]["Allpurpose"]["expenditure"];
                    wellData[countryName][year]["Allpurpose"]["expenditure"] += expenditure;
                    wellData[countryName][year]["Allpurpose"]["visitors"] += visitors;
                    wellData[countryName][year]["Allpurpose"]["avgNights"] += avgNights;
                    // calculate totalSpent for all years
                    if (!wellData[countryName]["Allpurpose"]) {
                        // wellData[countryName]["Allpurpose"] = 0;
                        wellData[countryName]["Allpurpose"] = {
                            "expenditure": 0,
                            "visitors": 0,
                            "avgNights": 0
                        }
                    }
                    if (countryName == "Germany") {
                        console.log(countryName);
                    }
                    wellData[countryName]["Allpurpose"]["expenditure"] += expenditure;
                    wellData[countryName]["Allpurpose"]["visitors"] += visitors;
                    wellData[countryName]["Allpurpose"]["avgNights"] += avgNights;
                }
            });

            keysSorted = Object.keys(wellData).sort(function (a, b) {
                // TODO total or average
                return wellData[b].Allpurpose.expenditure - wellData[a].Allpurpose.expenditure
            });
            keysSorted.forEach(function (d, i) {
                // remove the "allCountries" dimension
                if (d != "AllCountries") {
                    barX.push(d);
                    // TODO total or average
                    barY.push(wellData[d].Allpurpose.expenditure);
                }
            });

            //////////////////////
            var barData = [{
                x: barX,
                y: barY,
                type: 'bar',
                marker: {
                    color: colors[key]
                }
            }];
            layout_bar = {
                title: 'Total trip spent of ' + key + " when visitors visited Australia", // updates the title
                yaxis: {
                    title: 'Total trip spend ($)',
                    titlefont: {
                        family: 'Arial, sans-serif',
                        size: 18,
                        color: 'darkgrey'
                    }
                }
            };
            Plotly.newPlot('bar', barData, layout_bar);


            ///////// bubble charts////////
            // year as the axis
            var years = [];
            for (var i = 2006; i < 2017; i++) {
                years.push(i);
            }
            var bubbleData = [];
            // each category has a trace data for the bubble chart
            for (var c in categories) {
                var category = categories[c];
                // the y axis is average trip spent
                var traceY = [];
                var visitorsSize = [];
                var text = [];
                var color;
                // the x axis is year
                for (var i in years) {
                    var year = years[i];
                    var avgSpent = 0;
                    var totalVisitors = 0;
                    // use the all countries' data
                    var c_obj = wellData.AllCountries[year][category];
                    var visitors = c_obj["visitors"];
                    var exp = c_obj["expenditure"];
                    avgSpent += (exp / visitors);
                    traceY.push(avgSpent);
                    text.push("Visitors:" + Math.round(visitors / 1000) + "k");
                    visitorsSize.push(visitors / 30000);
                    color = colors[category];
                }
                var traceline = {
                    x: years,
                    y: traceY,
                    mode: 'line',
                    name: category == "Otherreason" ? "Other reasons" : category,
                    marker: {
                        size: visitorsSize,
                        color: color,
                    },
                    text: text
                };
                bubbleData.push(traceline);
            }
            var layout = {
                title: 'Marker Size',
                showlegend: true,
                height: 650,
                width: 1250,
                title: 'Average trip spent of different purpose in last decade',
                yaxis: {
                    title: 'Average trip spent($) of each visitor',
                    titlefont: {
                        family: 'Arial, sans-serif',
                        size: 18,
                        color: 'darkgrey'
                    }
                },
                xaxis: {
                    title: 'Year'
                }
            };
            Plotly.newPlot('bubble', bubbleData, layout);

        });
        key = "Allpurpose";
        keyOfMeasure = "TotalSpent";
        proportion = 700000000;
        map.loadMap('world.svg', function () {
            // do something with mymap, add layers etc.
            map.addLayer('countries', {
                styles: {
                    fill: '#dfdcdc',
                    stroke: '#fff'
                }
            });

            function symbolAttrs(d) {
                radius = getExpenditure(d) / proportion;
                return {
                    r: radius,
                    stroke: colors[key],
                    'stroke-width': 1,
                    fill: colors[key],
                    'fill-opacity': 0.5
                };
            }

            delete wellData.AllCountries;
            symbols = map.addSymbols({
                type: kartograph.Bubble,
                data: wellData,
                location: function (d) {
                    return [d.lon, d.lai];
                },
                attrs: symbolAttrs,
                title: function (d) {
                    return d.country + ": $" + d.Allpurpose.expenditure;
                }
            });

            updateMap = function () {
                key = $('.btn-primary').data('val');
                keyOfMeasure = $('.measure').data('val');
                // scale = kartograph.scale.linear(wellData, key);
                symbols.update({
                    attrs: symbolAttrs,
                    title: function (d) {
                        return d.country + ": $" + getExpenditure(d);
                        ;
                    }
                }, 500, 'backOut');
            }
            // add lables
            map.addSymbols({
                type: kartograph.Label,
                data: wellData,
                location: function (d) {
                    return [d.lon, Number(d.lai) - 3];
                },
                style: function (d) {
                    return 'font-family: AquilineTwoRegular; fill:black; fill-opacity: .58; font-size:12px;'
                },
                text: function (d) {
                    return d.country;
                }
            });

        })


        $('.purpose').click(function (event) {
            var tgt = $(event.target), par = tgt.parent();
            $('.purpose', par).removeClass('btn-primary');
            tgt.addClass('btn-primary');
            updateMap();
            // updateBarChart();
            updateBar();
        });

        $('.measure').click(function (event) {
            var tgt = $(event.target), par = tgt.parent();
            $('.measure', par).removeClass('btn-primary');
            $('.measure', par).removeClass('measure');
            tgt.addClass('btn-primary');
            tgt.addClass('measure');
            updateMap();
            // updateBarChart();
            updateBar();
        });

        // this is for plotly library, not woking currently
        updateBar = function () {
            key = $('.btn-primary').data('val');
            keyOfMeasure = $('.measure').data('val');
            var unsortedBar = {};
            // loop countries, put total expenditure into barY by category order
            barX.forEach(function (d, i) {
                var countryObj = wellData[d];
                if (d == "Germany") {
                    console.log(countryObj);
                }
                if (key == "Allpurpose") {
                    if (keyOfMeasure == "TotalSpent") {
                        unsortedBar[d] = countryObj.Allpurpose.expenditure;
                    } else {
                        console.log("visitors" + countryObj.Allpurpose.visitors);
                        if (countryObj.Allpurpose.visitors != 0) {
                            unsortedBar[d] = countryObj.Allpurpose.expenditure / countryObj.Allpurpose.visitors;
                        }
                    }
                } else {
                    var amountInKey = 0;
                    for (var i = 2006; i <= 2016; i++) {
                        // the bar chart is showing how much trip spent in y axis
                        // TODO total or average
                        if (keyOfMeasure == "TotalSpent") {
                            amountInKey += countryObj[i][key]["expenditure"];
                        } else {
                            if (countryObj[i][key]["visitors"] != 0) {
                                // 2006 - 2016 has 11 years in total
                                amountInKey += (countryObj[i][key]["expenditure"] / countryObj[i][key]["visitors"]) / 11;
                            }
                        }
                    }
                    unsortedBar[d] = amountInKey;
                }
            });

            // update keySorted 
            // In total, country A may have the highest expenditure 
            // However, regarding one specific category, e.g. Holiday, country B may have the highest expenditure
            // In this case, the bar chart need to be sorted accordingly
            keysSorted = Object.keys(unsortedBar).sort(function (a, b) {
                return unsortedBar[b] - unsortedBar[a];
            });
            barX = [];
            barY = [];
            keysSorted.forEach(function (d, i) {
                barX.push(d);
                barY.push(unsortedBar[d]);

            });

            var updatedData = [{
                x: barX,
                y: barY,
                type: 'bar',
                marker: {color: colors[key]}
            }];

            var barTitle;
            var yTitle;
            var t = key;
            if (keyOfMeasure == "TotalSpent") {
                yTitle = "Total spent of " + key;
            } else {
                yTitle = "Average spent of " + key;
            }
            barTitle = yTitle + "<br> when visitors visited Australia"
            layout_bar = {
                title: barTitle,
                yaxis: {
                    title: yTitle + ' ($)',
                    titlefont: {
                        family: 'Arial, sans-serif',
                        size: 18,
                        color: 'darkgrey'
                    }
                }
            };

            // 1) using animate way to re-render the bar chart
//            Plotly.animate('bar', {
//                data: updatedData,
//                layout: layout_update
//              }, {
//                // the animation is not working for bar char now
//                transition: {
//                  duration: 50000,
//                  easing: 'cubic-in-out'
//                }
//              })
            // 2) using newPlot to create a new plot
            Plotly.newPlot('bar', updatedData, layout_bar);
        }

    });

    // other methods for calculations
    // get expenditure based on different category
    function getExpenditure(d) {
        proportion = 500000000;
        if (key == "Allpurpose") {
            // TODO total or average
            if (keyOfMeasure == "TotalSpent") {
                return d.Allpurpose.expenditure;
            } else {
                proportion = 500;
                return d.Allpurpose.expenditure / d.Allpurpose.visitors;
            }
        } else {
            var amountInKey = 0;
            for (var i = 2006; i <= 2016; i++) {
                if (keyOfMeasure == "TotalSpent") {
                    amountInKey += d[i][key]["expenditure"];
                } else {
                    proportion = 500;
                    if (d[i][key]["visitors"] != 0) {
                        amountInKey += (d[i][key]["expenditure"] / d[i][key]["visitors"]) / 11;
                    }
                }
            }
            return amountInKey;
        }
    }

</script>
</body>
</html>